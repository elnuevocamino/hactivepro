import{generateTemplatedPrompt,displayPrompt}from"./prompt-generator.js";import{loadFormLogic}from"./form-logic-loader.js";import{renderFormFromJSON}from"./form-renderer.js";const formContainer=document.getElementById("form-viewer-container"),generateBtn=document.getElementById("generatePromptBtn"),outputContainer=document.getElementById("prompt-output-container"),MANIFEST_URL="/content/prompts/prompts-manifest.json";let validationErrorContainer;async function loadCustomForm(e,o){try{const r=await fetch(o);if(!r.ok)throw new Error(`No se encontró el formulario en ${o}. Estado: ${r.status}`);const t=await r.text();formContainer.innerHTML=t;const n=await loadFormLogic(e);return n&&"function"==typeof n.initialize&&n.initialize(),n}catch(e){return console.error("Error al cargar el formulario:",e),formContainer.innerHTML='<p class="error-message">Hubo un problema al cargar el formulario. Es posible que no exista o haya un error de red. Revisa que la URL sea correcta (ej: ?form=blog_form).</p>',generateBtn&&(generateBtn.style.display="none"),null}}function generatePromptFromTemplate(e,o){const r=new FormData(e),t={};if(o&&o.campos)o.campos.forEach(o=>{if("checkbox-group"===o.tipo){const e=r.getAll(o.id);e.length>0?t[o.id]=e.map(e=>`- ${e}`).join("\n"):t[o.id]=null}else if("table"===o.tipo){const r=[],n=e.querySelector(`#${o.id}`);if(n){n.querySelectorAll("tbody tr").forEach(e=>{const t={};let n=!1;o.columnas.forEach(o=>{const r=e.querySelector(`[data-column-id="${o.id}"]`);if(r){const e="checkbox"===r.type?r.checked:r.value.trim();t[o.id]=e,e&&(n=!0)}}),n&&r.push(t)})}t[o.id]=r}else t[o.id]=r.get(o.id)});else{console.warn("No se proporcionó la definición del formulario, la recopilación de datos puede ser imprecisa.");for(const[e,o]of r.entries())t[e]=o}let n=!0;if(e.querySelectorAll(".is-invalid").forEach(e=>e.classList.remove("is-invalid")),o.campos.forEach(o=>{if("table"===o.tipo){const r=e.querySelector(`#${o.id}`);r&&r.querySelectorAll("[required]").forEach(e=>{e.value.trim()||(e.classList.add("is-invalid"),n=!1)})}else if(o.requerido){const r=e.querySelector(`[name="${o.id}"]`);r&&!r.value.trim()&&((r.closest(".input-wrapper")||r).classList.add("is-invalid"),n=!1)}}),!n)return console.error("Por favor, completa todos los campos requeridos."),validationErrorContainer&&(validationErrorContainer.textContent="Por favor, completa todos los campos marcados en rojo.",validationErrorContainer.style.display="block"),null;const a=e.dataset.promptTemplate;if(!a)return console.error("No se encontró la plantilla del prompt en el formulario."),"Error: Plantilla de prompt no encontrada.";let i=a;i=i.replace(/{{#each (\w+)}}([\s\S]*?){{\/each}}/g,(e,o,r)=>{const n=t[o];return Array.isArray(n)&&0!==n.length?n.map(e=>{let o=r;o=o.replace(/{{#if this\.(\w+)}}([\s\S]*?){{\/if}}/g,(o,r,t)=>e[r]?t:"");for(const r in e)o=o.replace(new RegExp(`{{this.${r}}}`,"g"),e[r]);return o}).join(""):""});i=i.replace(/{{#if (\w+)}}([\s\S]*?){{\/if}}/g,(e,o,r)=>t[o]?r:"");for(const e in t){const o=t[e]||"";i=i.replace(new RegExp(`{{{${e}}}}`,"g"),o),i=i.replace(new RegExp(`{{${e}}}`,"g"),o)}return i.trim().replace(/\n\n+/g,"\n\n")}function setupEventListeners(e,o,r){generateBtn?generateBtn.addEventListener("click",()=>{outputContainer&&(outputContainer.style.display="none"),validationErrorContainer&&(validationErrorContainer.style.display="none");const t=formContainer.querySelector(".prompt-form");if(t){let n=null;o&&"function"==typeof o.generate?n=o.generate(t):t.dataset.promptTemplate?n=generatePromptFromTemplate(t,r):console.error(`No se encontró una función 'generate' para el formId: ${e} ni una plantilla en el formulario.`),n&&displayPrompt(n,outputContainer)}else console.error("No se encontró un elemento .prompt-form dentro del contenedor para generar el prompt.")}):console.error("El botón #generatePromptBtn no se encontró en la página.")}function displaySuggestedTools(e){const o=document.getElementById("form-tools-container");if(!o)return;if(!e.suggestedTools||0===e.suggestedTools.length)return void(o.style.display="none");o.innerHTML="",o.style.display="block";const r=document.createElement("span");r.textContent="Úsalo en: ",o.appendChild(r),e.suggestedTools.forEach((r,t)=>{const n=document.createElement("a");if(n.href=r.url,n.textContent=r.name,n.target="_blank",n.rel="noopener noreferrer",o.appendChild(n),t<e.suggestedTools.length-1){const e=document.createTextNode(", ");o.appendChild(e)}})}function setupNavigation(e,o){const r=document.getElementById("prevPromptBtn"),t=document.getElementById("nextPromptBtn"),n=document.getElementById("prompt-navigation");if(r&&t&&n){if(e>0){const t=o[e-1];r.href=`?form=${t.id}`,r.style.display="inline-block"}else r.style.display="none";if(e<o.length-1){const r=o[e+1];t.href=`?form=${r.id}`,t.style.display="inline-block"}else t.style.display="none"}}export async function initializeFormViewer(){if(formContainer){generateBtn&&generateBtn.parentNode&&(validationErrorContainer=document.createElement("div"),validationErrorContainer.id="form-validation-error",validationErrorContainer.className="form-validation-message",validationErrorContainer.style.display="none",generateBtn.parentNode.insertBefore(validationErrorContainer,generateBtn));try{const e=new URLSearchParams(window.location.search).get("form");if(!e)throw new Error("No se especificó un ID de formulario en la URL.");const o=await fetch(MANIFEST_URL);if(!o.ok)throw new Error("No se pudo cargar el manifiesto de prompts.");const r=await o.json(),t=r.findIndex(o=>o.id===e);if(-1===t)throw new Error(`No se encontró un prompt con el ID "${e}" en el manifiesto.`);const n=r[t],a=document.getElementById("form-title"),i=document.getElementById("form-description");a&&(a.textContent=n.title),i&&(i.textContent=n.description),document.title=`${n.title} - HactivePro`;let l=null,s=null;if(n.customPagePath)displaySuggestedTools(n),l=await loadCustomForm(e,n.customPagePath);else{if(!n.templatedJsonPath)throw new Error(`El manifiesto para "${e}" no especifica una ruta válida (customPagePath o templatedJsonPath).`);try{const e=await fetch(n.templatedJsonPath);if(!e.ok)throw new Error(`No se pudo cargar la definición del formulario: ${n.templatedJsonPath}`);if(s=await e.json(),s.campos.some(e=>"table"===e.tipo)){const e=document.createElement("link");e.rel="stylesheet",e.href="/css/dynamic-table.css",document.head.appendChild(e)}displaySuggestedTools(s),renderFormFromJSON(s,formContainer)}catch(e){console.error("Error al renderizar el formulario desde JSON:",e),formContainer.innerHTML='<p class="error-message">Error al cargar el formulario. Por favor, inténtalo de nuevo más tarde.</p>'}}setupEventListeners(e,l,s),setupNavigation(t,r)}catch(e){console.error("Error al inicializar el visor de formularios:",e),formContainer.innerHTML=`<p class="error-message">${e.message} Por favor, vuelve a la <a href="/content/prompts/prompts.html">galería de prompts</a>.</p>`,generateBtn&&(generateBtn.style.display="none")}}else console.error("Contenedor de formulario #form-viewer-container no encontrado. Abortando.")}